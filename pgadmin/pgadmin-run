#!/bin/bash

# grab the username
source /etc/profile.d/0000-env.sh
eval $(cat /etc/cont-init.d/001-userconf.sh  | grep -E "^export USER_NAME" | envsubst)
eval $(cat /etc/cont-init.d/001-userconf.sh  | grep -E "^export GROUP_NAME" | envsubst)

# Set the default username and password
export PGADMIN_USER=${USER_NAME:=liveware}
export USER_EMAIL=${USER_EMAIL:=${PGADMIN_USER}'@localhost.com'}
export PGADMIN_EMAIL=${USER_EMAIL}
export PGADMIN_SETUP_EMAIL=${PGADMIN_EMAIL}
export PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL}

export PGADMIN_PASSWORD=${PASSWORD:=password}
export PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL}
export PGADMIN_SETUP_EMAIL=${PGADMIN_EMAIL}
#export PGADMIN_SETUP_PASSWORD=${PGADMIN_PASSWORD}

export PGADMIN_DIR=${PGADMIN_DIR:="/usr/local/pgadmin4"}

export PGADMIN_DATA_DIR="$(su - ${USER_NAME} -c 'echo ${XDG_DATA_HOME}/pgadmin4')"
export PGADMIN_STORAGE_DIR=${PGADMIN_STORAGE_DIR:=${PGADMIN_DATA_DIR}/storage}
export PGADMIN_SQLITE_PATH=${PGADMIN_DATA_DIR}/pgadmin4.db
export PGADMIN_SESSION_DB_PATH=${PGADMIN_DATA_DIR}/sessions

export PGADMIN_LOG_DIR="/var/log/pgadmin"
export PGADMIN_LOG_FILE=${PGADMIN_LOG_DIR}"/pgadmin4.log"

# setup config_distro.py
config_distro_path=${PGADMIN_DIR}/config_distro.py
touch ${config_distro_path}

echo "
LOG_FILE = '/dev/null'
DEFAULT_BINARY_PATHS = {
        'pg': '$(which psql)'
}

MASTER_PASSWORD_REQUIRED = False
DATA_DIR                 = '${PGADMIN_DATA_DIR}'
SQLITE_PATH              = '${PGADMIN_SQLITE_PATH}'
SESSION_DB_PATH          = '${PGADMIN_SESSION_DB_PATH}'
STORAGE_DIR              = '${PGADMIN_STORAGE_DIR}'
ENABLE_PSQL              = True
SERVER_MODE              = True
UPGRADE_CHECK_ENABLED    = False
LOG_FILE                 = '${PGADMIN_LOG_FILE}'
DESKTOP_USER             = '${PGADMIN_DEFAULT_EMAIL}'
PGADMIN_DEFAULT_EMAIL    = '${PGADMIN_DEFAULT_EMAIL}'
PGADMIN_SETUP_EMAIL      = '${PGADMIN_DEFAULT_EMAIL}'
PGADMIN_DEFAULT_PASSWORD = '${PGADMIN_PASSWORD}'
PGADMIN_SETUP_PASSWORD   = '${PGADMIN_PASSWORD}'

# Number of values to trust for X-Forwarded-For
PROXY_X_FOR_COUNT    = 10
PROXY_X_PROTO_COUNT  = 10
PROXY_X_HOST_COUNT   = 10
PROXY_X_PORT_COUNT   = 10
PROXY_X_PREFIX_COUNT = 10
X_FRAME_OPTIONS = ''

" > ${config_distro_path}


# propagate PGADMIN_CONFIG_* env vars to config_ditro.py
for var in $(env | grep PGADMIN_CONFIG_ | cut -d "=" -f 1); do
    echo "${var##PGADMIN_CONFIG_} = ${var}" >> ${config_distro_path}
    #echo ${var##PGADMIN_CONFIG_} = $(eval "echo \$$var") >> ${config_distro_path}
done

# Initialize DB before starting Gunicorn
# Importing pgadmin4 (from this script) is enough
#su - ${USER_NAME} -c "${PGADMIN_BASE_DIR}/venv/bin/python3 ${PGADMIN_DIR}/run_pgadmin.py"
mkdir -p ${PGADMIN_LOG_DIR}
chown -R ${USER_NAME}:${GROUP_NAME} ${PGADMIN_DIR}
chown -R ${USER_NAME}:${GROUP_NAME} ${PGADMIN_LOG_DIR}

su - ${USER_NAME} -c "
export DESKTOP_USER=${PGADMIN_EMAIL}
export PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL}
export PGADMIN_SETUP_EMAIL=${PGADMIN_EMAIL}
export PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD}
export PGADMIN_SETUP_PASSWORD=${PGADMIN_PASSWORD}
cd ${PGADMIN_DIR} \
&& source ${PGADMIN_DIR}/venv/bin/activate \
&& python /usr/local/pgadmin4/setup.py --user ${PGADMIN_SETUP_EMAIL} \
&& ${PGADMIN_DIR}/venv/bin/gunicorn \
--timeout 86400 \
--bind 0.0.0.0:5050 \
-e SCRIPT_NAME=/pgadmin \
--pythonpath=${PGADMIN_DIR} \
-w 1 \
--threads 25 \
--access-logfile - \
-c gunicorn_config.py \
run_pgadmin:app
"
